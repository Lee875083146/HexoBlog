<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="AOP与Spring-AOP"><meta name="keywords" content="SpringBoot,Spring,AOP"><meta name="author" content="nopainanymore"><meta name="copyright" content="nopainanymore"><title>AOP与Spring-AOP | No Pain AnyMore</title><link rel="shortcut icon" href="https://nopainanymore.oss-cn-hangzhou.aliyuncs.com/favicon.jpg?x-oss-process=style/sw-white"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?https://hm.baidu.com/hm.js?ca6ee8d386d608e489e2f483d8553676";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"TBN51XHQ7I","apiKey":"ad36c28a1992fcfba299a447cf3558b9","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E7%AE%80%E4%BB%8B-%E7%94%A8%E5%A4%84"><span class="toc-number">1.</span> <span class="toc-text"> AOP简介、用处</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aop%E4%B8%AD%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text"> AOP中的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aspectj"><span class="toc-number">3.</span> <span class="toc-text"> AspectJ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aspectj%E7%BB%87%E5%85%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text"> AspectJ织入方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-aop"><span class="toc-number">4.</span> <span class="toc-text"> Spring AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text"> 动态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text"> JDK动态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cglib%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text"> CGLIB动态代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aspectj-%E4%B8%8E-spring-aop%E5%AF%B9%E6%AF%94"><span class="toc-number">5.</span> <span class="toc-text"> AspectJ 与 Spring AOP对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springboot-%E4%B8%AD%E4%BD%BF%E7%94%A8aop"><span class="toc-number">6.</span> <span class="toc-text"> SpringBoot 中使用AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">6.1.</span> <span class="toc-text"> 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8aspect%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E5%88%87%E9%9D%A2"><span class="toc-number">6.2.</span> <span class="toc-text"> 使用Aspect注解实现切面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E9%9D%A2%E4%BD%9C%E7%94%A8%E7%9B%AE%E6%A0%87"><span class="toc-number">6.3.</span> <span class="toc-text"> 切面作用目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E5%85%A5%E7%82%B9%E6%8C%87%E7%A4%BA%E7%AC%A6"><span class="toc-number">6.4.</span> <span class="toc-text"> 切入点指示符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="toc-number">6.4.1.</span> <span class="toc-text"> 通配符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E7%AD%BE%E5%90%8D%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">6.4.2.</span> <span class="toc-text"> 类型签名表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">6.4.3.</span> <span class="toc-text"> 方法签名表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8C%87%E7%A4%BA%E7%AC%A6"><span class="toc-number">6.4.4.</span> <span class="toc-text"> 其他指示符</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text"> 参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://ww1.sinaimg.cn/large/005yN1Nlgy1g0lee3rjxbj311s0scgpu.jpg"></div><div class="author-info__name text-center">nopainanymore</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/Lee875083146">GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">78</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">93</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">83</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">No Pain AnyMore</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/readingPlan">ReadingPlan</a><a class="site-page" href="/about">About</a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">AOP与Spring-AOP</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-04</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring/"> Spring</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring/AOP/"> AOP</a></div><div class="article-container" id="post-content"><p>Spring AOP实现原理学习及如何在SpringBoot中使用。<br />
<a target="_blank" rel="noopener" href="https://github.com/Lee875083146/deep-in-spring">Github代码地址</a></p>
<a id="more"></a>
<h2 id="aop简介-用处"><a class="markdownIt-Anchor" href="#aop简介-用处"></a> AOP简介、用处</h2>
<p>AOP(Aspect Orient Programming)，称为面向切面编程，作为面向对象的一种补充，用于处理系统中分布于各个模块的横切关注点，比如事物管理、日志、缓存等。</p>
<p>AOP实现的关键在于AOP框架自动创建的AOP代理，AOP代理主要分为静态代理和动态代理，静态代理表现为AspectJ，动态代理则以Spring AOP为代表。</p>
<p>AOP的出现解决外围业务代码与核心业务代码分离的问题，OOP的出现是把编码问题进行模块化，AOP就是把涉及到众多模块的某一类问题进行统一管理。功能代码不再单独入侵到核心业务类的代码中，即核心模块只需关注自己相关的业务。</p>
<h2 id="aop中的概念"><a class="markdownIt-Anchor" href="#aop中的概念"></a> AOP中的概念</h2>
<p><strong>Pointcut</strong>：是一组基于正则表达式的表达式。通常一个pointcut会选择程序中的某些执行点，或执行点的集合。</p>
<p><strong>JoinPoint</strong>：通过pointcut选取出来的集合中具体的一个执行点</p>
<p><strong>Advice</strong>：在选取出来的JoinPoint上要执行的操作、逻辑，通知有以下五种类型。</p>
<ul>
<li><code>before</code>目标方法执行前执行，前置通知</li>
<li><code>after</code>目标方法执行后执行，后置通知</li>
<li><code>after returning</code>目标方法返回时通知，后置返回通知</li>
<li><code>after throwing</code>目标方法抛出异常时执行，异常通知</li>
<li><code>around</code>在目标函数执行中执行，可控制目标函数是否执行(通过proceed)，环绕通知</li>
</ul>
<p><strong>Aspect</strong>：就是我们关注点的模块化。这个关注点可能会横切多个对象和模块，事务管理是横切关注点的很好的例子。是一个抽象的概念，从软件的角度来说是指在应用程序不同模块中的某一个领域或方面。由pointcut 和advice组成。</p>
<p><strong>Weaving</strong>：把切面应用到目标对象并创建新的代理对象的过程。切面在指定的连接点被织入到目标对象。在目标对象的生命周期里有多个点可以进行织入：</p>
<ul>
<li>编译期：切面在目标类编译时被织入。Aspect的织入编译器就是以这种方式织入切面的。</li>
<li>类加载期：切面在目标类加载到JVM时被织入。需要特殊的类加载(Classloader)，它可以在目标类被引入之前增强该目标类的字节码(CGlib)</li>
<li>运行期：切面在应用运行时的某个时刻被织入。AOP会为目标对象创建一个代理对象</li>
</ul>
<h2 id="aspectj"><a class="markdownIt-Anchor" href="#aspectj"></a> AspectJ</h2>
<p>AspectJ是一个Java实现的AOP框架，它能够对Java代码进行AOP编译，让Java代码具有AspectJ的AOP功能。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pointcut 函数名 : 匹配表达式</span><br></pre></td></tr></table></figure>
<h3 id="aspectj织入方式"><a class="markdownIt-Anchor" href="#aspectj织入方式"></a> AspectJ织入方式</h3>
<p>AspectJ采用静态织入的方式。主要采用的是编译期织入，在这个期间AspectJ的<em>acj</em>编译器(类似javac)把<code>aspect</code>类编译成class字节码后，在java目标类编译时织入，即先编译<code>aspect</code>类再编译目标类。除了编译期织入还存在链接期织入，即将<code>aspect</code>类和java目标类同时编译成字节码文件后，再进行织入处理，有助于已编译好的第三方jar和Class文件进行织入操作。</p>
<h2 id="spring-aop"><a class="markdownIt-Anchor" href="#spring-aop"></a> Spring AOP</h2>
<p>Spring AOP 与ApectJ 的目的一致，都是为了统一处理横切业务，但与AspectJ不同的是，Spring AOP 并不尝试提供完整的AOP功能，<strong>Spring AOP 更注重的是与Spring IOC容器的结合</strong>，并结合该优势来解决横切业务的问题，因此在AOP的功能完善方面，相对来说AspectJ具有更大的优势，同时，Spring采用动态代理技术的实现原理来构建Spring AOP的内部机制，这是与AspectJ最根本的区别。</p>
<h3 id="动态代理"><a class="markdownIt-Anchor" href="#动态代理"></a> 动态代理</h3>
<p>Spring AOP使用动态代理，动态代理不会去修改字节码，而是在内存中临时为方法生成一个AOP对象，该对象包含了对象目标的全部方法，并且在特定的切点做了增强处理，并调用原对象的方法。动态代理分为JDK动态代理和CGLIB动态代理。</p>
<h3 id="jdk动态代理"><a class="markdownIt-Anchor" href="#jdk动态代理"></a> JDK动态代理</h3>
<p>JDK动态代理基于反射技术实现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExInterface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EClass</span> <span class="keyword">implements</span> <span class="title">ExInterface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;EClass- execute- execute method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EClass target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JDKProxy</span><span class="params">(EClass target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExInterface <span class="title">createProxy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ExInterface) Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.equals(ExInterface.class.getDeclaredMethod(<span class="string">&quot;execute&quot;</span>))) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;JDKProxy- invoke- before&quot;</span>);</span><br><span class="line">            Object result = method.invoke(target, args);</span><br><span class="line">            log.info(<span class="string">&quot;JDKProxy- invoke- after&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EClass eClass = <span class="keyword">new</span> EClass();</span><br><span class="line">        JDKProxy proxy = <span class="keyword">new</span> JDKProxy(eClass);</span><br><span class="line">        proxy.createProxy().execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>被代理的类必须实现接口，JDK提供的Proxy类将通过目标对象的类加载器和接口，以及句柄创建与目标对象类具有相同接口的代理对象proxy，代理对象的创建是通过Proxy类达到的，Proxy类由Java JDK提供，利用Proxy#newProxyInstance方法便可以动态生成代理对象(proxy)，底层通过反射实现的。该代理对象将拥有目标对象所实现接口中的所有方法，同时代理类必须实现InvokeHandler接口并重写invoke方法，<strong>当调用proxy的每个方法时，invoke方法将被调用</strong>，利用该特性可以在invoke方法中对目标对象方法执行的前后进行添加其他的操作，无需触及目标对象的任何代码，实现了AOP功能。缺点在于需要有接口。</p>
<blockquote>
<p>当代理对象生成后，最后由InvocationHandler的invoke()方法调用目标方法:</p>
</blockquote>
<p>在动态代理中InvocationHandler是核心，每个代理实例都具有一个关联的调用处理程序(InvocationHandler)。<br />
对代理实例调用方法时，将对方法调用进行编码并将其指派到它的调用处理程序(InvocationHandler)的invoke()方法。<br />
所以对代理方法的调用都是通InvocationHadler的invoke来实现中，而invoke方法根据传入的代理对象，方法和参数来决定调用代理的哪个方法。</p>
<h3 id="cglib动态代理"><a class="markdownIt-Anchor" href="#cglib动态代理"></a> CGLIB动态代理</h3>
<p>CGLIB动态代理基于继承的方式实现，免去了接口的实现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;EClass- execute- execute&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EClass target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CGLibProxy</span><span class="params">(EClass target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EClass <span class="title">createProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使用CGLIB生成代理:</span></span><br><span class="line">        <span class="comment">// 1.声明增强类实例,用于生产代理类</span></span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        <span class="comment">// 2.设置被代理类字节码，CGLIB根据字节码生成被代理类的子类</span></span><br><span class="line">        enhancer.setSuperclass(target.getClass());</span><br><span class="line">        <span class="comment">// 3.//设置回调函数，即一个方法拦截</span></span><br><span class="line">        enhancer.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 4.创建代理:</span></span><br><span class="line">        <span class="keyword">return</span> (EClass) enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.equals(EClass.class.getDeclaredMethod(<span class="string">&quot;execute&quot;</span>))) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;CGLibProxy- intercept- before&quot;</span>);</span><br><span class="line">            Object result = methodProxy.invokeSuper(proxy, args);</span><br><span class="line">            log.info(<span class="string">&quot;CGLibProxy- intercept- after&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(proxy, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EClass eClass = <span class="keyword">new</span> EClass();</span><br><span class="line">        CGLibProxy proxy = <span class="keyword">new</span> CGLibProxy(eClass);</span><br><span class="line">        proxy.createProxy().execute();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>CGLibProxy代理类需要实现一个方法拦截器接口<code>MethodInterceptor</code>并重写<code>intercept</code>方法，类似JDK动态代理的<code>InvocationHandler</code>接口，也是理解为回调函数，同理每次调用代理对象的方法时，<code>intercept</code>方法都会被调用，利用该方法便可以在运行时对方法执行前后进行动态增强。代理对象创建则通过<code>Enhancer</code>类来设置的，<code>Enhancer</code>是一个用于产生代理对象的类，作用类似JDK的Proxy类，因为CGLib底层是通过继承实现的动态代理，因此需要传递目标对象的Class，同时需要设置一个回调函数对调用方法进行拦截并进行相应处理，最后通过create()创建目标对象的代理对象。</p>
<p>在Spring AOP中，当有接口时会自动选择JDK动态代理技术，如果没有则选择CGLIB技术。</p>
<h2 id="aspectj-与-spring-aop对比"><a class="markdownIt-Anchor" href="#aspectj-与-spring-aop对比"></a> AspectJ 与 Spring AOP对比</h2>
<p>AspectJ和Spring AOP都是对目标类增强，生成代理类。</p>
<p>AspectJ是编译期增强，而SpringAOP是运行时增强。</p>
<p>AspectJ是在编译期间将切面代码编译到目标代码的，属于静态代理；Spring AOP是在运行期间通过代理生成目标类，属于动态代理。</p>
<p>AspectJ是静态代理，故而能够切入final修饰的类，abstract修饰的类；Spring AOP是动态代理，其实现原理是通过CGLIB生成一个继承了目标类(委托类)的代理类，因此，final修饰的类不能被代理，同样static和final修饰的方法也不会代理，因为static和final方法是不能被覆盖的。在CGLIB底层，其实是借助了ASM这个非常强大的Java字节码生成框架。关于CGLB和ASM的讨论将会新开一个篇幅探讨。</p>
<p>Spring AOP支持注解，在使用@Aspect注解创建和配置切面时将更加方便。而使用AspectJ，需要通过.aj文件来创建切面，并且需要使用ajc（Aspect编译器）来编译代码。</p>
<h2 id="springboot-中使用aop"><a class="markdownIt-Anchor" href="#springboot-中使用aop"></a> SpringBoot 中使用AOP</h2>
<h3 id="引入依赖"><a class="markdownIt-Anchor" href="#引入依赖"></a> 引入依赖</h3>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用aspect注解实现切面"><a class="markdownIt-Anchor" href="#使用aspect注解实现切面"></a> 使用Aspect注解实现切面</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@org</span>.aspectj.lang.annotation.Aspect</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public * com.nopainanymore.deepinspring.AOP.AOPController.*(..)))</span><span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void pointCut() &#123;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Before(&quot;</span>pointCut()<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void doBefore(JoinPoint joinPoint) &#123;</span></span><br><span class="line"><span class="string">        ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doBefore:&#123;&#125;<span class="string">&quot;, gson.toJson(requestAttributes.getRequest().getRequestedSessionId()));</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doBefore:&#123;&#125;<span class="string">&quot;, joinPoint.toShortString());</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doBefore- before the pointCut<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @After(&quot;</span>pointCut()<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void doAfter() &#123;</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doAfter- after the pointCut<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @AfterReturning(pointcut = &quot;</span>pointCut()<span class="string">&quot;, returning = &quot;</span>ret<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void doAfterReturning(String ret) &#123;</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doAfterReturning:&#123;&#125;<span class="string">&quot;, ret);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @AfterThrowing(pointcut = &quot;</span>pointCut()<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void doAfterThrowing() &#123;</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doAfterThrowing- Exception<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Around(&quot;</span>pointCut()<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public String doAround(ProceedingJoinPoint proceedingJoinPoint) &#123;</span></span><br><span class="line"><span class="string">        log.info(&quot;</span>Aspect- doAround- start<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        try &#123;</span></span><br><span class="line"><span class="string">            return (String) proceedingJoinPoint.proceed();</span></span><br><span class="line"><span class="string">        &#125; catch (Throwable throwable) &#123;</span></span><br><span class="line"><span class="string">            log.info(&quot;</span>Aspect- doAround- end<span class="string">&quot;);</span></span><br><span class="line"><span class="string">            return throwable.getMessage();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<h3 id="切面作用目标"><a class="markdownIt-Anchor" href="#切面作用目标"></a> 切面作用目标</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/aop&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">aop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;AOPController- aop: hello AOP &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;AOP&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="切入点指示符"><a class="markdownIt-Anchor" href="#切入点指示符"></a> 切入点指示符</h3>
<p>用于定义匹配方法通知到目标方法的规则。</p>
<h4 id="通配符"><a class="markdownIt-Anchor" href="#通配符"></a> 通配符</h4>
<table>
<thead>
<tr>
<th>符号</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>匹配任意数量的字符</td>
</tr>
<tr>
<td>…</td>
<td>匹配方法定义中的任意数量的参数，此外还匹配类定义中的任意数量包</td>
</tr>
<tr>
<td>+</td>
<td>匹配给定类的任意子类</td>
</tr>
</tbody>
</table>
<h4 id="类型签名表达式"><a class="markdownIt-Anchor" href="#类型签名表达式"></a> 类型签名表达式</h4>
<p><code>thin(&lt;type name&gt;)</code></p>
<h4 id="方法签名表达式"><a class="markdownIt-Anchor" href="#方法签名表达式"></a> 方法签名表达式</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//scope ：方法作用域，如public,private,protect</span></span><br><span class="line"><span class="comment">//returnt-type：方法返回值类型</span></span><br><span class="line"><span class="comment">//fully-qualified-class-name：方法所在类的完全限定名称</span></span><br><span class="line"><span class="comment">//parameters 方法参数</span></span><br><span class="line">execution(&lt;scope&gt; &lt;<span class="keyword">return</span>-type&gt; &lt;fully-qualified-<span class="class"><span class="keyword">class</span>-<span class="title">name</span>&gt;.*(<span class="title">parameters</span>))</span></span><br></pre></td></tr></table></figure>
<h4 id="其他指示符"><a class="markdownIt-Anchor" href="#其他指示符"></a> 其他指示符</h4>
<table>
<thead>
<tr>
<th>指示符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>bean</td>
<td>用于匹配特定名称的Bean对象的执行方法</td>
</tr>
<tr>
<td>this</td>
<td>用于匹配当前AOP代理对象类型的执行方法；</td>
</tr>
<tr>
<td>target</td>
<td>用于匹配当前目标对象类型的执行方法；</td>
</tr>
<tr>
<td>@within</td>
<td>用于匹配所以持有指定注解类型内的方法；请注意与within是有区别的， within是用于匹配指定类型内的方法执行；</td>
</tr>
<tr>
<td>@annotation</td>
<td>根据所应用的注解进行方法过滤</td>
</tr>
</tbody>
</table>
<blockquote>
<p>指示符可以使用运算符语法进行表达式的混编，如and、or、not（或者&amp;&amp;、||、！）</p>
</blockquote>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<p><a target="_blank" rel="noopener" href="http://www.importnew.com/24305.html">http://www.importnew.com/24305.html</a><br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/javazejian/article/details/56267036">https://blog.csdn.net/javazejian/article/details/56267036</a><br />
<a target="_blank" rel="noopener" href="https://github.com/landy8530/DesignPatterns#231-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F">https://github.com/landy8530/DesignPatterns#231-策略模式实现方式</a><br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/yhl_jxy/article/details/80586785">https://blog.csdn.net/yhl_jxy/article/details/80586785</a><br />
<a target="_blank" rel="noopener" href="http://blog.didispace.com/springbootaoplog/">http://blog.didispace.com/springbootaoplog/</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">nopainanymore</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://nopainanymore.me/Spring-AOP/">http://nopainanymore.me/Spring-AOP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a><a class="post-meta__tags" href="/tags/Spring/">Spring</a><a class="post-meta__tags" href="/tags/AOP/">AOP</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://nopainanymore.oss-cn-hangzhou.aliyuncs.com/wechat.jpg?x-oss-process=style/sw-white"><div class="post-qr-code__desc">wechat</div></div></div><div class="social-share" data-disabled="diandian,tencent,qzone,google"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/OOP-Understanding/"><i class="fa fa-chevron-left">  </i><span>OOP与AOP</span></a></div><div class="next-post pull-right"><a href="/AbstractClassInterface-Understanding/"><span>[转载]深入理解abstract class和interface</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'b5808ee24dc05257f520',
  clientSecret: '4b96b67ee846f12c0c590dfd71312ba19edea774',
  repo: 'lee875083146.github.io',
  owner: 'Lee875083146',
  admin: 'Lee875083146',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By nopainanymore</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>