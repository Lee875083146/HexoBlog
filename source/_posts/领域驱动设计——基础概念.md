---
title: 领域驱动设计——基础概念
tags: [领域驱动设计,DDD]
categories:
- 领域驱动设计
- 基础概念
date: 2019-10-28 19:04:16
entitle: DomainDrivenDesign-Concept
---

一直对领域驱动设计很感兴趣，领域驱动设计在我看来，是面向对象的高层次体现。本文谈谈我对领域驱动设计的理解，以及其基本概念，包括领域、子域、核心域、通用域、支撑域、限界上下文、实体、值对象、聚合和聚合根等概念。领域驱动相关概念来自[DDD实战课](https://time.geekbang.org/column/intro/238)，有条件的也可以一起学习。

<!--more-->
## 从面向对象到领域驱动设计

> 面向对象主要思维特点是逻辑分析思维，认为万物皆有边界，如同世界这个词语一样，通过寻找边界封装定义一个事物，然后再探究这个事物内部的组成部分，通过封装不变性，开放变化性，增强系统的柔韧性和灵活性。

在设计及代码层面上，单一职责原则、开放封闭原则、接口隔离原则、里氏代换原则、依赖倒转原则、合成复用原则、迪米特法则指导下的设计模式，能帮助我们更好的组织以及重构代码。

将其进一步上升到项目、业务层面上，演化为领域驱动设计Domain-Driven Design（DDD）。DDD核心思想就是通过领域驱动设计方法定义领域模型，从而确定业务和应用边界，保证业务模型与代码模型的一致性，将问题分解，降低业务理解和系统实现的复杂度。

## 领域驱动之基础概念

### 界限上下文、领域、子域、核心域、通用域、支撑域

随着业务的发展，其内部的逻辑和角色会逐渐膨胀庞大，此时将业务细分，将业务进行归类划分为一个一个的服务，判断的依据就是业务边界，DDD的领域就是这个边界要解决的业务问题域，而这个边界就是我们所说的界限上下文。

对于一个领域，可以进一步划分，划分出来的多个子领域称为子域，每个子域对应一个更小的问题域或者更小的业务范围。

子域根据自身的重要性和功能属性可以划分为三类子域：核心域、通用域和支撑域。

核心域是产品和公司最为核心的业务，每个产品或者公司对于核心域的理解是不同的。

能够被多个子域使用的通用功能子域是通用域。

既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域，就是支撑域。

### 实体和值对象

实体和值对象是组成领域模型的基础单元。

#### 实体

领域模型中的实体是多个属性、操作或行为的载体，对应业务对象，具有业务属性和业务行为。

在代码模型中，实体表现形式是实体类，包含了实体的属性和方法，在DDD中这些实体类通常采用充血模型。与本实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现。

DDD与传统数据库驱动设计不同的是，首先对业务进行分析建模，构建实体对象和确定实体的行为，再将实体对象映射成为数据库持久化对象，其对应关系可以为一对一也可为一对多。

#### 值对象

通过对象属性值来识别的对象，它将多个属性组合为一个概念整体。用来描述领域的特定方面，是一个没有标识符的对象。

值对象仅仅是数据的集合，其中包含的数据用于描述目的、具有整体概念和不可修改的属性，值对象用来保证属性归类的清晰和概念的完整性。

值对象的代码形态：
1. 如果值对象是单一属性，可以直接定义为实体类的属性
2. 如果值对象是属性集合，则可以定义为类，实体整体引用

值对象的运行形态：
1. 属性嵌入：
2. 序列化大对象

#### 区别联系

在某一个业务领域中实体为主角，值对象为配角，在分割实体和值对象时，需要结合当前的领域仔细分析。

在领域建模时，可以将部分对象设计为值对象，保留对象的业务含义，同时减少实体的数量；在数据建模时，将值对象嵌入实体，减少实体表的数量，简化数据库设计。

值对象是一把双刃剑：
* 采用了序列化大对象的方式简化数据库设计，减少实体表数量，但无法满足基于值对象但快速查询，使得检索对象属性值变得困难
* 使用属性嵌入的方式提升了数据库的性能，但引用但值对象过多会导致实体堆积一堆缺乏概念完整性的属性

个人看法，DDD提倡从领域设计出发，而不是先设计数据模型。在与数据库的交互过程中，需要一个强大的ORM框架，在从数据库到内存实体的映射的过程中提供便捷的实现。

有一点困惑，就是实体在内存中时，其引用的对象作为其他领域的实体，怎样保证修改的统一性。需要后面思考。

### 聚合、聚合根

#### 聚合

领域模型内的实体和值对象就好比个体，而能让实体和值对象协同工作的组织就是聚合，用来保证领域对象在实现共同逻辑时，能保证数据的一致性。

聚合是业务和逻辑紧密关联的实体和值对象组合而成的，聚合是数据修改和持久化的基本单元，没一个聚合对应一个仓储，实现数据的持久化。

聚合有一个聚合根和上下文边界，上下文边界根据业务单一职责和高内聚原则定义了聚合内部应该包含哪些实体和值对象，而聚合之间的边界是松耦合的。

聚合在DDD分层架构里属于领域层，领域层包含了多个聚合，共同实现核心业务逻辑。聚合内实体以充血模型实现个体业务能力以及业务逻辑的高内聚。跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。

#### 聚合根

在传统的数据模型中，实体数据的修改调用如果不加以控制则会导致实体之间数据逻辑的不一致，采用锁就会增加软件复杂度、牺牲性能。

在DDD中聚合根的主要目的就是避免由于复杂数据模型缺少统一业务规则控制，而导致聚合、实体之间数据不一致的问题。

聚合根也称为根实体，它本身就是一个实体，同时也是聚合的管理者。作为实体，聚合根拥有实体的属性和业务方法，实现自身的业务逻辑；作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成相同的业务逻辑。

在聚合之间的业务调用，聚合根负责对外的接口，以聚合根ID关联的方式接受外部任务和请求，在上下文内实现聚合之间的业务协同。

#### 设计聚合

1. 事件风暴，找出业务中的所以实体和值对象
2. 在实体中找出适合的聚合根。是否有独立的生命周期？是否有全局唯一ID？是否可以创建、修改其他对象？是否有专门的模块管理该实体？
3. 根据业务单一职责和高内聚原则，找出与聚合根关联的紧密依赖实体和值对象。
4. 在聚合内根据聚合根、实体和值对象的依赖关系，画出对象的引用和依赖模型。
5. 多个聚合根据业务语义和上下文一起划到同一个界限上下文内。

设计原则：
* 在一致性边界内建模真正的不变条件，聚合、界限上下文要准确
* 设计小聚合，聚合过大会导致聚合内实体过多，管理复杂，高频操作会有并发问题、数据库锁等问题
* 通过唯一标识引用其他聚合
* 在边界之外使用最终一致性，聚合内数据强一致性，而聚合之间数据最终一致性，在一次事务中最多只能更改一个聚合的状态。如果业务操作设计多个聚合状态的更改，采用领域事件的方式异步修改相关的聚合，实现聚合之间的解耦。
* 通过应用层实现跨聚合的服务调用
